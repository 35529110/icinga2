%define revision 1
%define opensuse_boost_version 1_49_0

%define logmsg logger -t %{name}/rpm

Summary: network monitoring application
Name: @PACKAGE@
Version: @VERSION@
Release: %{revision}%{?dist}
License: GPLv2+
Group: Applications/System
Source: %{name}-%{version}.tar.gz
URL: http://www.icinga.org/
BuildRoot:      %{_tmppath}/%{name}-%{version}-build

BuildRequires: doxygen
BuildRequires: openssl-devel
BuildRequires: gcc-c++
BuildRequires: libstdc++-devel
BuildRequires: automake
BuildRequires: autoconf
BuildRequires: libtool
BuildRequires: flex
BuildRequires: bison

# TODO: figure out how to handle boost on el5
%if "%{_vendor}" == "redhat"
BuildRequires: libtool-ltdl-devel
BuildRequires: boost >= 1.41
BuildRequires: boost-devel >= 1.41
BuildRequires: boost-test >= 1.41
Requires: boost >= 1.41
%endif

%if "%{_vendor}" == "suse"
BuildRequires: libgfortran45
BuildRequires: boost-devel >= 1.41
Requires: libboost_program_options%{opensuse_boost_version}
Requires: libboost_signals%{opensuse_boost_version}
Requires: libboost_system%{opensuse_boost_version}
Requires: libboost_test%{opensuse_boost_version}
Requires: libboost_thread%{opensuse_boost_version}
%endif


%description
Icinga is a general-purpose network monitoring application.

%package ido-mysql
Summary:      IDO MySQL database backend for Icinga 2
Group:        Applications/System
%if "%{_vendor}" == "suse"
BuildRequires: libmysqlclient-devel
Requires: libmysqlclient18
%endif
%if "%{_vendor}" == "redhat"
BuildRequires: mysql
BuildRequires: mysql-devel
Requires: mysql
%endif

%description ido-mysql 
Icinga 2 IDO mysql database backend. Compatible with Icinga 1.x
IDOUtils schema >= 1.10


%prep
%setup -q -n %{name}-%{version}

%build
%configure --with-icinga-user=$USER \
	--with-icinga-group=$USER \
	--with-icingacmd-user=$USER \
	--with-icingacmd-group=$USER

make %{?_smp_mflags}

%install
[ "%{buildroot}" != "/" ] && [ -d "%{buildroot}" ] && rm -rf %{buildroot}
make install \
	DESTDIR="%{buildroot}" \
	INSTALL_OPTS="" \
	COMMAND_OPTS=""

%pre
%{_sbindir}/groupadd icinga 2> /dev/null || :
%{_sbindir}/groupadd icingacmd 2> /dev/null || :
%{_sbindir}/useradd -c "icinga" -s /sbin/nologin -r -d %{_localstatedir}/spool/%{name} -G icingacmd -g icinga icinga 2> /dev/null || :

%post
/sbin/chkconfig --add %{name}
/sbin/service %{name} start &>/dev/null || :

%preun
if [ $1 -eq 0 ]; then
	/sbin/service %{name} stop &>/dev/null || :
	/sbin/chkconfig --del %{name}
fi

%postun

%clean
[ "%{buildroot}" != "/" ] && [ -d "%{buildroot}" ] && rm -rf %{buildroot}

%files
%defattr(-,root,root)
%doc README AUTHORS ChangeLog COPYING COPYING.Exceptions
%config(noreplace) %{_sysconfdir}/%{name}/%{name}.conf
%config(noreplace) %{_sysconfdir}/%{name}/conf.d/*.conf
%config(noreplace) %{_sysconfdir}/%{name}/features-available/*.conf
%config(noreplace) %{_sysconfdir}/%{name}/features-enabled/*.conf
%attr(755,-,-) %{_sysconfdir}/init.d/%{name}
%{_bindir}/%{name}
%{_sbindir}/i2enfeature
%{_sbindir}/i2disfeature
%exclude %{_libdir}/%{name}/libdb_ido_mysql*
%{_libdir}/%{name}
%{_datadir}/doc/%{name}
%{_datadir}/%{name}
%{_mandir}/man8/%{name}.8.gz

%{_localstatedir}/cache/%{name}
%{_localstatedir}/log/%{name}
%{_localstatedir}/run/%{name}
%{_localstatedir}/lib/%{name}
%{_localstatedir}/spool/%{name}

%attr(2755,icinga,icingacmd) %{_localstatedir}/run/icinga2/cmd

%files ido-mysql
%{_libdir}/%{name}/libdb_ido_mysql*


%changelog
* Tue Oct 01 2013 Michael Friedrich <michael.friedrich@netways.de> - 0.0.3-1
- revamp package

* Sat May 04 2013 Michael Friedrich <michael.friedrich@netways.de> - 0.0.2-1
- new initscript in initdir
- itl is installed into datadir
- man pages in mandir
- use name macro to avoid typos

* Fri Nov 19 2012 Gunnar Beutner <gunnar.beutner@netways.de> - 0.0.1-1
- initial version
